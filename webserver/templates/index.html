<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>YugabyteDB Log Analyzer</title>
    <link rel="stylesheet" href="/static/app.css" />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="/static/app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="modern-header">
      <img
        class="yuga-logo"
        src="/img/yugabytedb-icon-seeklogo.svg"
        alt="YugabyteDB Logo"
      />
      <a href="/" class="no-underline-inherit">
        <span class="yuga-title">YugabyteDB Log Analyzer</span>
      </a>
    </div>
    <div class="yuga-container">
      <div class="modern-search-bar">
        <input
          id="searchBox"
          type="text"
          placeholder="Search by UUID, bundle, cluster, org, or case ID..."
        />
        <button id="searchBtn">Search</button>
        <button id="clearSearchBtn">Clear</button>
      </div>
      <div id="modern-pagination"></div>
      <div id="modernReportsList">
        {% if reports|length == 0 %}
        <div class="modern-no-reports">No reports found.</div>
        {% else %}
        <table class="modern-reports-table">
          <thead>
            <tr>
              <th>Bundle Name</th>
              <th>UUID</th>
              <th>Cluster</th>
              <th>Org</th>
              <th>Created</th>
              <th>Case</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody>
            {% for report in reports %}
            <tr>
              <td>{{ report.support_bundle_name }}</td>
              <td style="font-family: monospace">{{ report.id }}</td>
              <td>{{ report.universe_name }}</td>
              <td>{{ report.organization_name }}</td>
              <td>{{ report.created_at }}</td>
              <td>
                {% if report.case_id %}<a
                  class="modern-case-link"
                  href="https://yugabyte.zendesk.com/agent/tickets/{{ report.case_id }}"
                  target="_blank"
                  >{{ report.case_id }}</a
                >{% else %}-{% endif %}
              </td>
              <td>
                <a
                  class="modern-view-btn"
                  href="/reports/{{ report.id }}"
                  title="View Report"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    fill="none"
                    viewBox="0 0 20 20"
                    style="vertical-align: middle"
                  >
                    <path
                      fill="currentColor"
                      d="M10 4c-5 0-8 5.5-8 6s3 6 8 6 8-5.5 8-6-3-6-8-6zm0 10c-3.9 0-6.6-3.7-7.3-5C3.4 7.7 6.1 4 10 4s6.6 3.7 7.3 5c-.7 1.3-3.4 5-7.3 5zm0-8a3 3 0 100 6 3 3 0 000-6zm0 5a2 2 0 110-4 2 2 0 010 4z"
                    />
                  </svg>
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </div>
    </div>
    <script>
      const searchBox = document.getElementById('searchBox');
      const searchBtn = document.getElementById('searchBtn');
      const clearSearchBtn = document.getElementById('clearSearchBtn');
      const modernReportsList = document.getElementById('modernReportsList');
      let currentPage = {{ page|default(1) }};
      let totalPages = {{ total_pages|default(1) }};
      let lastQuery = '';
      function renderReportsTable(reports) {
        const modernReportsList = document.getElementById('modernReportsList');
        modernReportsList.innerHTML = '';
        if (!reports || reports.length === 0) {
          modernReportsList.innerHTML = '<div class="modern-no-reports">No reports found.</div>';
          return;
        }
        let html = `<table class='modern-reports-table'><thead><tr>
          <th>Bundle Name</th>
          <th>UUID</th>
          <th>Cluster</th>
          <th>Org</th>
          <th>Created</th>
          <th>Case</th>
          <th>Action to View</th>
        </tr></thead><tbody>`;
        for (const report of reports) {
          html += `<tr>
            <td>${report.support_bundle_name}</td>
            <td style='font-family:monospace;'>${report.id}</td>
            <td>${report.universe_name}</td>
            <td>${report.organization_name}</td>
            <td>${report.created_at}</td>
            <td>${report.case_id ? `<a class='modern-case-link' href='https://yugabyte.zzendesk.com/agent/tickets/${report.case_id}' target='_blank'>${report.case_id}</a>` : '-'}</td>
            <td><a class='modern-view-btn' href='/reports/${report.id}' title='View Report'><svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' fill='none' viewBox='0 0 20 20' style='vertical-align:middle;'><path fill='currentColor' d='M10 4c-5 0-8 5.5-8 6s3 6 8 6 8-5.5 8-6-3-6-8-6zm0 10c-3.9 0-6.6-3.7-7.3-5C3.4 7.7 6.1 4 10 4s6.6 3.7 7.3 5c-.7 1.3-3.4 5-7.3 5zm0-8a3 3 0 100 6 3 3 0 000-6zm0 5a2 2 0 110-4 2 2 0 010 4z'/></svg></a></td>
          </tr>`;
        }
        html += '</tbody></table>';
        modernReportsList.innerHTML = html;
      }
      function renderPagination(page, totalPages) {
        const pagination = document.getElementById('modern-pagination');
        if (totalPages <= 1) { pagination.innerHTML = ''; return; }
        let html = `<nav class="modern-pager"><ul>`;
        if (page > 1) html += `<li><button class="page-btn" data-page="${page-1}">&laquo;</button></li>`;
        for (let p = 1; p <= totalPages; ++p) {
          if (p === 1 || p === totalPages || (p >= page-2 && p <= page+2)) {
            html += `<li><button class="page-btn${p===page?' active':''}" data-page="${p}">${p}</button></li>`;
          } else if (p === page-3 || p === page+3) {
            html += `<li><span class="dots">...</span></li>`;
          }
        }
        if (page < totalPages) html += `<li><button class="page-btn" data-page="${page+1}">&raquo;</button></li>`;
        html += `</ul></nav>`;
        pagination.innerHTML = html;
        document.querySelectorAll('.page-btn').forEach(btn => {
          btn.onclick = function() {
            goToPage(parseInt(btn.getAttribute('data-page')));
          };
        });
      }
      function goToPage(page) {
        currentPage = page;
        const perPage = 10;
        if (lastQuery) {
          searchBtn.disabled = true;
          searchBtn.textContent = 'Searching...';
          fetch(`/api/search_reports?q=${encodeURIComponent(lastQuery)}&page=${page}&per_page=${perPage}`)
            .then(r => r.json())
            .then(data => {
              renderReportsTable(data.reports);
              renderPagination(data.page, data.total_pages);
              searchBtn.disabled = false;
              searchBtn.textContent = 'Search';
            })
            .catch(() => {
              renderReportsTable([]);
              renderPagination(1, 1);
              searchBtn.disabled = false;
              searchBtn.textContent = 'Search';
            });
        } else {
          window.location = `/?page=${page}`;
        }
      }
      searchBtn.onclick = function() {
        const q = searchBox.value.trim();
        if (!q) return;
        lastQuery = q;
        currentPage = 1;
        const perPage = 10;
        searchBtn.disabled = true;
        searchBtn.textContent = 'Searching...';
        fetch(`/api/search_reports?q=${encodeURIComponent(q)}&page=1&per_page=${perPage}`)
          .then(r => r.json())
          .then(data => {
            renderReportsTable(data.reports);
            renderPagination(data.page, data.total_pages);
            searchBtn.disabled = false;
            searchBtn.textContent = 'Search';
          })
          .catch(() => {
            renderReportsTable([]);
            renderPagination(1, 1);
            searchBtn.disabled = false;
            searchBtn.textContent = 'Search';
          });
      };
      clearSearchBtn.onclick = function() {
        searchBox.value = '';
        window.location.reload();
      };
      searchBox.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') searchBtn.onclick();
      });
      renderPagination(currentPage, totalPages);
    </script>
    <!-- Floating Help Button -->
    <button id="help-fab" title="Help">
      <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
        <circle cx="14" cy="14" r="14" fill="#3b5bdb" />
        <text
          x="50%"
          y="55%"
          text-anchor="middle"
          fill="#fff"
          font-size="18"
          font-family="Inter,Arial,sans-serif"
          dy=".3em"
        >
          ?
        </text>
      </svg>
    </button>
    <!-- Help Modal -->
    <div id="help-modal" class="help-modal-overlay" style="display: none">
      <div class="help-modal-content help-modal">
        <button class="help-modal-close" id="help-modal-close" title="Close">
          &times;
        </button>
        <h2>Log Analyzer Help Center</h2>
        <p class="help-modal-desc">
          Welcome! Hereâ€™s how to use the Log Analyzer effectively:
        </p>
        <ul class="help-modal-list mb-1-5em">
          <li>
            <b>Search:</b> Use the search bar to find reports by UUID, bundle
            name, cluster, org, or case ID. Results update instantly.
          </li>
          <li>
            <b>Pagination:</b> Use the page controls below the search bar to
            navigate through multiple pages of reports.
          </li>
          <li>
            <b>View Reports:</b> Click the <b>View</b> button to see a detailed
            analysis for a specific report.
          </li>
          <li>
            <b>Case Links:</b> If a report is linked to a support case, click
            the case ID to open it in Zendesk.
          </li>
        </ul>
        <h3>How to Run Log Analyzer</h3>
        <ol class="mb-1-5em">
          <li>
            Run against support bundle <br /><code
              >log_analyzer.py -s yb-support-bundle-test-universe-20250101000000_logs.tar.gz</code
            >
          </li>
          <li>
            Run against parquet file <br /><code
              >log_analyzer.py --parquet_files parquet_files/yb-support-bundle-test-universe-20250101000000_logs</code
            >
          </li>
        </ol>
        <h3>How to delete a report</h3>
        <p>
          To delete a report, run the following command:
          <code>
            <br/>
            curl -X DELETE http://your-api-/api/reports/{report_uuid}
          </code>
        </p>
        <div class="help-modal-tip">
          <b>Need more help? Drop a message to </b>
          <a href="https://yugabyte.slack.com/archives/D02TSRPK9SA" target="_blank"
            >Current maintainer</a
          >
        </div>
      </div>
    </div>
    <script>
      // Help modal logic
      const helpFab = document.getElementById("help-fab");
      const helpModal = document.getElementById("help-modal");
      const helpModalClose = document.getElementById("help-modal-close");
      helpFab.onclick = function () {
        helpModal.style.display = "flex";
      };
      helpModalClose.onclick = function () {
        helpModal.style.display = "none";
      };
      helpModal.onclick = function (e) {
        if (e.target === helpModal) helpModal.style.display = "none";
      };
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") helpModal.style.display = "none";
      });
    </script>
  </body>
</html>
